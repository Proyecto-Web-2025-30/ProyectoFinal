<app-navbar></app-navbar>

<div class="designer">
  <div class="sidebar" draggable="false">
    <h3>Palette</h3>
    <div class="palette-item activity" draggable="true"
         (dragstart)="onPaletteDragStart($event, 'ACTIVITY')">Activity</div>

    <div class="palette-gateway" draggable="true"
         (dragstart)="onPaletteDragStart($event, 'GATEWAY:EXCLUSIVE')">
      <div class="diamond"><span class="marker">×</span></div>
      <span class="label">Exclusive Gateway</span>
    </div>
    <div class="palette-gateway" draggable="true"
         (dragstart)="onPaletteDragStart($event, 'GATEWAY:PARALLEL')">
      <div class="diamond"><span class="marker">＋</span></div>
      <span class="label">Parallel Gateway</span>
    </div>
    <div class="palette-gateway" draggable="true"
         (dragstart)="onPaletteDragStart($event, 'GATEWAY:INCLUSIVE')">
      <div class="diamond"><span class="marker">◯</span></div>
      <span class="label">Inclusive Gateway</span>
    </div>
    <div class="hint">Tip: Hold Shift and click source, then click target to create an arc. To delete an existing arc, try creating a new arc over the same source and target.</div>
  </div>

  <div class="canvas-wrapper">
    <div class="canvas"
         #canvas
         (dragover)="onCanvasDragOver($event)"
         (drop)="onCanvasDrop($event)"
         (click)="onCanvasClick($event)">

      <svg class="edges" xmlns="http://www.w3.org/2000/svg">
        <line *ngFor="let arc of arcs"
              [attr.x1]="getEdgeX(arc.sourceType, arc.sourceId, arc.targetType, arc.targetId)"
              [attr.y1]="getEdgeY(arc.sourceType, arc.sourceId, arc.targetType, arc.targetId)"
              [attr.x2]="getEdgeX(arc.targetType, arc.targetId, arc.sourceType, arc.sourceId)"
              [attr.y2]="getEdgeY(arc.targetType, arc.targetId, arc.sourceType, arc.sourceId)"
              stroke="#999" stroke-width="2" marker-end="url(#arrow)" />
        <defs>
          <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="3" orient="auto" markerUnits="strokeWidth">
            <path d="M0,0 L0,6 L9,3 z" fill="#999" />
          </marker>
        </defs>
      </svg>

      <div *ngFor="let a of activities"
           class="node activity-node"
           [class.selected]="isSelected('ACTIVITY', a.id)"
           [style.left.px]="a.x || 40"
           [style.top.px]="a.y || 40"
           (click)="onNodeClick($event, 'ACTIVITY', a)"
           (mousedown)="onNodeMouseDown($event, 'ACTIVITY', a)">
        {{ a.name || 'Activity' }}
      </div>

      <div *ngFor="let g of gateways"
           class="node gateway-node"
           [class.selected]="isSelected('GATEWAY', g.id)"
           [style.left.px]="g.x || 40"
           [style.top.px]="g.y || 40"
           (click)="onNodeClick($event, 'GATEWAY', g)"
           (mousedown)="onNodeMouseDown($event, 'GATEWAY', g)">
        <span class="marker">
          {{ g.gatewayType === 'EXCLUSIVE' ? '×' : (g.gatewayType === 'PARALLEL' ? '＋' : '◯') }}
        </span>
      </div>
    </div>
  </div>

  <div class="inspector" *ngIf="selected">
    <h3>Properties</h3>
    <div *ngIf="selected.type === 'ACTIVITY'">
      <label>Name</label>
      <input [(ngModel)]="activityForm.name" />
      <label>Type</label>
      <input [(ngModel)]="activityForm.activityType" />
      <label>Description</label>
      <textarea [(ngModel)]="activityForm.description"></textarea>
      <button (click)="saveSelected()">Save</button>
      <button (click)="deleteSelected()">Delete</button>
    </div>
    <div *ngIf="selected.type === 'GATEWAY'">
      <label>Name</label>
      <input [(ngModel)]="gatewayForm.name" />
      <label>Type</label>
      <select [(ngModel)]="gatewayForm.gatewayType">
        <option value="EXCLUSIVE">Exclusive</option>
        <option value="PARALLEL">Parallel</option>
        <option value="INCLUSIVE">Inclusive</option>
      </select>
      <label>Conditions</label>
      <textarea [(ngModel)]="gatewayForm.conditions"></textarea>
      <button (click)="saveSelected()">Save</button>
      <button (click)="deleteSelected()">Delete</button>
    </div>
  </div>
</div>
